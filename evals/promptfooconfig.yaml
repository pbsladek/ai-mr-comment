description: "ai-mr-comment response quality evals on curated diff fixtures"

prompts:
  - "{{diff_path}}"

providers:
  - id: "exec:./evals/providers/run-ai-mr-comment.sh"
    label: "ai-mr-comment-e2e"

tests:
  - description: "Detect SQL injection and suggest parameterized query fix"
    vars:
      diff_path: "evals/fixtures/sql_injection.diff"
      min_score: 0.75
      expected_findings:
        - id: "sql_injection"
          severity: "high"
          keywords:
            - "sql injection"
            - "injection"
            - "fmt.Sprintf"
            - "concatenat"
          fix_keywords:
            - "parameterized"
            - "placeholder"
            - "prepared statement"
    assert:
      - type: javascript
        value: |
          const scorer = require('./evals/scorers/review-quality.js');
          return scorer(output, context);

  - description: "Detect admin auth bypass / authorization removal"
    vars:
      diff_path: "evals/fixtures/auth_bypass.diff"
      min_score: 0.75
      expected_findings:
        - id: "auth_bypass"
          severity: "high"
          keywords:
            - "authorization"
            - "authentication"
            - "forbidden"
            - "access control"
            - "auth bypass"
          fix_keywords:
            - "reintroduce"
            - "authorization check"
            - "permission check"
    assert:
      - type: javascript
        value: |
          const scorer = require('./evals/scorers/review-quality.js');
          return scorer(output, context);

  - description: "Detect nil pointer panic risk"
    vars:
      diff_path: "evals/fixtures/nil_panic.diff"
      min_score: 0.7
      expected_findings:
        - id: "nil_pointer"
          severity: "medium"
          keywords:
            - "nil"
            - "panic"
            - "nil pointer"
            - "dereference"
          fix_keywords:
            - "nil check"
            - "guard"
            - "defensive"
    assert:
      - type: javascript
        value: |
          const scorer = require('./evals/scorers/review-quality.js');
          return scorer(output, context);

  - description: "Detect map access race condition after lock removal"
    vars:
      diff_path: "evals/fixtures/race_condition.diff"
      min_score: 0.75
      expected_findings:
        - id: "race_condition"
          severity: "high"
          keywords:
            - "race condition"
            - "data race"
            - "concurrent"
            - "mutex"
            - "lock"
          fix_keywords:
            - "mutex"
            - "lock"
            - "synchronize"
    assert:
      - type: javascript
        value: |
          const scorer = require('./evals/scorers/review-quality.js');
          return scorer(output, context);

  - description: "Avoid false positives on safe refactor diff"
    vars:
      diff_path: "evals/fixtures/clean_refactor.diff"
      min_score: 0.85
      should_be_clean: true
      clean_forbidden_terms:
        - "sql injection"
        - "xss"
        - "csrf"
        - "race condition"
        - "data race"
        - "panic"
        - "auth bypass"
    assert:
      - type: javascript
        value: |
          const scorer = require('./evals/scorers/review-quality.js');
          return scorer(output, context);
